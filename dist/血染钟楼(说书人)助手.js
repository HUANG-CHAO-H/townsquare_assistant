/*! 
// ==UserScript==
// @name         血染钟楼(说书人)助手
// @namespace    http://tampermonkey.net/
// @version      0.0.1
// @description  向https://www.imdodo.com/tools/clocktower/页面注入一些JavaScript代码，来帮助说书人完成一些自动化操作，让说书人能够更加高效的工作
// @author       huangchao.hello
// @match        https://www.imdodo.com/tools/clocktower/
// @require      https://unpkg.com/react@18/umd/react.production.min.js
// @require      https://unpkg.com/react-dom@18/umd/react-dom.production.min.js
// @require      https://unpkg.com/@douyinfe/semi-ui@2.17.1/dist/umd/semi-ui.min.js
// @require      https://unpkg.com/@douyinfe/semi-icons@2.17.1/dist/umd/semi-icons.min.js
// @require      https://unpkg.com/@douyinfe/semi-illustrations@2.15.0/dist/umd/semi-illustrations.min.js
// @icon         <$ICON$>
// ==/UserScript==
 */
(function(s,p){typeof exports=="object"&&typeof module<"u"?p(require("react"),require("react-dom"),require("@douyinfe/semi-ui"),require("@douyinfe/semi-icons")):typeof define=="function"&&define.amd?define(["react","react-dom","@douyinfe/semi-ui","@douyinfe/semi-icons"],p):(s=typeof globalThis<"u"?globalThis:s||self,p(s.React,s.ReactDOM,s.SemiUI,s.SemiIcons))})(this,function(s,p,a,z){"use strict";const B=e=>e&&typeof e=="object"&&"default"in e?e:{default:e},E=B(s),H=B(p);var b={},_=H.default;b.createRoot=_.createRoot,b.hydrateRoot=_.hydrateRoot;const I=new Set;function O(e){if(I.has(e))return;const t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,document.head.appendChild(t),I.add(e)}const T=new Map;async function $(e){let t=T.get(e);if(t)return t;const n=await fetch(e);if(n.status!==200){console.error("\u52A0\u8F7DJSON\u8D44\u6E90\u5931\u8D25");return}return t=await n.json(),T.set(e,t),t}function g(e){return new Promise(t=>setTimeout(t,e))}function v(e){if(!e)return console.error("dispatchClickEvent Error: element \u4E0D\u5B58\u5728"),Promise.resolve(!1);const t=new MouseEvent("click",{bubbles:!0,cancelable:!0});return new Promise(n=>{setTimeout(()=>n(!1),50),e.addEventListener("click",()=>n(!0),{once:!0}),e.dispatchEvent(t)})}let m;async function V(){if(m)return m;const e=await $("https://raw.githubusercontent.com/bra1n/townsquare/develop/src/roles.json");if(e instanceof Array){m={};for(const t of e)m[t.id]=t;return m}}function N(){return document.querySelector("div.modal-backdrop.game-state")}function W(){return document.querySelector("div.df-chat-detail")}async function x(e=!0){let t=N();if(e){if(t)return}else if(!t)return;let n=null;for(let o=0;o<3;o++){const u=document.querySelectorAll("div.menu > ul > li");if(!u||!u.length)throw new Error("\u672A\u6355\u83B7\u5230li\u6570\u7EC4");if(u.length===9&&u[4].innerText.includes("JSON")){n=u[4];break}const l=document.querySelector("div.menu > ul > li.tabs > svg.fa-question");if(!l)throw new Error("\u672A\u6355\u83B7\u5230help\u6309\u94AE");await v(l),await g(100)}if(!n)throw new Error("\u672A\u6355\u6349\u5230JSON\u6309\u94AE");await v(n);for(let o=0;o<3;o++){if(t=N(),e){if(t)return}else if(!t)return;await g(50)}throw new Error("JSON\u72B6\u6001\u5F39\u7A97\u5207\u6362\u5931\u8D25")}async function G(){await x(!0);const e=document.querySelector("div.modal-backdrop.game-state div.slot > textarea");return e?e.value:(console.error("\u6355\u83B7JSON\u5C55\u793A\u533A textarea \u5143\u7D20\u5931\u8D25"),"")}async function R(e){const t=document.querySelectorAll("#townsquare > ul.circle > li");if(e<1||e>t.length)return console.error("userIndex \u8D85\u51FA\u4E86\u9884\u5B9A\u8303\u56F4",e),!1;const n=t[e-1].querySelector("div.player");if(!n)return console.error("\u672A\u6355\u6349\u5230\u7528\u6237\u5EA7\u4F4D\u6240\u5728\u7684div"),!1;for(let u=0;u<3;u++){const l=n.querySelector("ul.menu");if(l){const i=l.lastChild;await v(i),await g(50);break}await v(n.querySelector("div.name")),await g(50)}return document.querySelector("div.df-chat-detail")?!0:(console.error("\u6253\u5F00\u804A\u5929\u7A97\u53E3\u5931\u8D25"),!1)}async function Y(){const e={userName:"",content:""},t=document.querySelector("div.df-chat-detail");if(!t)return console.error("readChatContent Error: \u672A\u6355\u6349\u5230\u804A\u5929\u7A97\u53E3"),e;let n=t.querySelector("div.title-wrap");return e.userName=(n==null?void 0:n.innerText)||"",n=t.querySelector("div.df-scroll_wrap"),e.content=(n==null?void 0:n.innerHTML)||"",e}async function X(e,t="",n=!1){if(!await R(e))return!1;const o=W();if(!o)return console.error("\u6253\u5F00\u804A\u5929\u7A97\u53E3\u5931\u8D25"),!1;const u=o.querySelector("div.input-wrap > div > div#content");if(!u)return console.error("\u6355\u83B7\u804A\u5929\u8F93\u5165\u6846\u5143\u7D20\u5931\u8D25"),!1;u.innerHTML=t;const l=new InputEvent("input");if(u.dispatchEvent(l),n){const i=o.querySelector("div.input-wrap > div > div.btn");if(!i)return console.error("\u6355\u83B7\u804A\u5929\u53D1\u9001\u6309\u94AE\u5931\u8D25"),!1;await v(i)}return!0}var w={exports:{}},A={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var K=E.default,Q=Symbol.for("react.element"),Z=Symbol.for("react.fragment"),U=Object.prototype.hasOwnProperty,ee=K.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,te={key:!0,ref:!0,__self:!0,__source:!0};function F(e,t,n){var o,u={},l=null,i=null;n!==void 0&&(l=""+n),t.key!==void 0&&(l=""+t.key),t.ref!==void 0&&(i=t.ref);for(o in t)U.call(t,o)&&!te.hasOwnProperty(o)&&(u[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps,t)u[o]===void 0&&(u[o]=t[o]);return{$$typeof:Q,type:e,key:l,ref:i,props:u,_owner:ee.current}}A.Fragment=Z,A.jsx=F,A.jsxs=F,function(e){e.exports=A}(w);const P=w.exports.Fragment,r=w.exports.jsx,c=w.exports.jsxs,j=E.default.createContext(void 0);function ne(e){const[t,n]=s.useState(void 0),[o,u]=s.useState(""),[l,i]=s.useState("");s.useEffect(()=>{if(!e.assistantOpen)return;let S="";const f=setInterval(async()=>{Y().then(y=>{u(y.userName),i(y.content)});const k=await G();if(!k||k===S)return;const C=JSON.parse(S=k);C.roles=C.roles||[];const fe=await V()||{};for(const y of C.players){const M=y.role;typeof M=="string"?y.role=fe[M]||null:y.role=null}n(C)},500);return()=>clearInterval(f)},[e.assistantOpen]);const d=s.useMemo(()=>({gameState:t,chatUser:o,chatContent:l,assistantOpen:e.assistantOpen}),[t,o,l,e.assistantOpen]);return r(j.Provider,{value:d,children:e.children})}function J(){return s.useContext(j)}function L(e){const{playerInfo:t,size:n,avatarStyle:o,containerStyle:u}=e,l=r(a.Avatar,{size:n||"small",src:t.avatarUrl,style:o||{marginRight:12}});let i=l,d=t.name;return t.countUnread?i=r(a.Badge,{count:t.countUnread,type:"primary",children:l}):t.isDead&&(i=r(a.Badge,{count:"\u6B7B\u4EA1",type:"danger",children:l})),t.isDead&&(d=r("span",{style:re,children:t.name})),c("div",{style:u,children:[i,d]})}const re={textDecoration:"line-through",color:"gray"};function D(e){const{roleId:t,size:n,style:o}=e;if(!e.roleId)return null;const u=`https://raw.githubusercontent.com/bra1n/townsquare/develop/src/assets/icons/${t}.png`;return r(a.Avatar,{size:n,src:u,style:o})}function oe(){var n;const e=J(),t=((n=e==null?void 0:e.gameState)==null?void 0:n.players)||[];return console.log(e),r(a.Table,{bordered:!0,columns:ue,dataSource:t,pagination:!1})}const ue=[{title:"\u5EA7\u4F4D\u53F7",dataIndex:"seatIndex",width:50,render(e,t,n){return String(n+1)}},{title:"\u73A9\u5BB6",dataIndex:"name",width:150,render(e,t){return r(L,{playerInfo:t,size:"small"})}},{title:"\u89D2\u8272",width:150,render(e,t){const n=t.role;return n?c("div",{children:[r(D,{roleId:n.id,style:{marginRight:12}}),String(n.name)]}):null}},{title:"\u9996\u591C",width:50,render(e,t){const n=t.role;return n!=null&&n.firstNight?r(a.Tooltip,{content:n.firstNightReminder||"",children:r(a.Avatar,{size:"small",color:"red",shape:"square",alt:"0",children:n.firstNight})}):null}},{title:"\u975E\u9996\u591C",width:50,render(e,t){const n=t.role;return n!=null&&n.otherNight?r(a.Tooltip,{content:n.otherNightReminder||"",children:r(a.Avatar,{size:"small",color:"green",shape:"square",alt:"0",children:n.otherNight})}):null}},{title:"\u81EA\u5B9A\u4E49\u6807\u8BB0",width:200,render(e,t){const n=t.reminders;return n!=null&&n.length?r(P,{children:n.map(o=>o.role==="custom"?r(a.Tooltip,{content:o.name,children:r(a.Avatar,{size:"small",color:"green",alt:"0",children:o.name})}):r(a.Tooltip,{content:o.name,children:r(D,{roleId:o.role})}))}):null}},{title:"\u64CD\u4F5C",width:100,render(e,t,n){return r(a.Button,{icon:r(z.IconCustomerSupport,{style:{color:"#E91E63"}}),onClick:()=>R(n+1)})}}];function ae(){var d,S;const e=J(),[t,n]=s.useState(""),o=s.useRef(null),u=()=>{!t||X(l+1,t,!0).then(()=>{n(""),setTimeout(()=>{const f=o.current;f&&(f.scrollTop=f.scrollHeight)},500)})};if(!((d=e==null?void 0:e.gameState)!=null&&d.players))return null;const l=e.gameState.players.findIndex(f=>f.name===e.chatUser);if(l<0)return null;const i=e.gameState.players[l];return c(a.Layout,{style:{color:"black",padding:"10px",height:"100%"},children:[c("div",{children:[r(a.Avatar,{color:"red",shape:"square",alt:"0",children:r("span",{style:{fontSize:"large"},children:l+1})}),r(D,{roleId:((S=i.role)==null?void 0:S.id)||""}),r(L,{playerInfo:i,containerStyle:{display:"inline-block"}})]}),r("br",{}),r("div",{children:"\u81EA\u5B9A\u4E49\u529F\u80FD\u5217\u8868"}),r("br",{}),r("div",{ref:o,style:le,dangerouslySetInnerHTML:{__html:(e==null?void 0:e.chatContent)||""}}),r("br",{}),c(a.Row,{gutter:16,type:"flex",align:"middle",children:[r(a.Col,{span:20,children:r(a.TextArea,{value:t,onChange:n,onEnterPress:u})}),r(a.Col,{span:4,children:r(a.Button,{block:!0,onClick:u,children:"\u53D1\u9001"})})]})]})}const le={height:"60%",overflowX:"auto",overflowY:"scroll",borderStyle:"inset",borderWidth:"2px"};function se(){const[e,t]=s.useState(!1),n=s.useCallback(()=>t(o=>!o),[]);return s.useEffect(()=>{x(!!e)},[e]),c(P,{children:[r(a.Button,{theme:"solid",type:"secondary",onClick:n,style:ie,children:"\u52A9\u624B"}),r(a.SideSheet,{closeOnEsc:!0,placement:"bottom",height:"80%",headerStyle:ce,bodyStyle:de,visible:e,onCancel:n,children:r(ne,{assistantOpen:e,children:c(a.Row,{gutter:16,style:q,children:[r(a.Col,{style:q,span:16,children:r(oe,{})}),r(a.Col,{style:q,span:8,children:r(ae,{})})]})})})]})}const ie={position:"absolute",top:0,left:"70%"},ce={display:"none"},de={padding:"0"},q={height:"100%"},h=document.createElement("div");h.id="assist-root",h.style.position="absolute",h.style.top="0",h.style.width="100%",document.body.appendChild(h),O("https://unpkg.com/@douyinfe/semi-ui@2.17.1/dist/css/semi.css"),O("https://unpkg.com/@douyinfe/semi-icons@2.17.1/dist/css/semi-icons.css"),b.createRoot(h).render(r(E.default.StrictMode,{children:r(se,{})}))});
