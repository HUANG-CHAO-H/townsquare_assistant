/*! 
// ==UserScript==
// @name         血染钟楼(说书人)助手
// @namespace    http://tampermonkey.net/
// @version      0.0.1
// @description  向https://www.imdodo.com/tools/clocktower/页面注入一些JavaScript代码，来帮助说书人完成一些自动化操作，让说书人能够更加高效的工作
// @author       huangchao.hello
// @match        https://www.imdodo.com/tools/clocktower/
// @require      https://unpkg.com/react@18/umd/react.production.min.js
// @require      https://unpkg.com/react-dom@18/umd/react-dom.production.min.js
// @require      https://unpkg.com/@douyinfe/semi-ui@2.17.1/dist/umd/semi-ui.min.js
// @require      https://unpkg.com/@douyinfe/semi-icons@2.17.1/dist/umd/semi-icons.min.js
// @require      https://unpkg.com/@douyinfe/semi-illustrations@2.15.0/dist/umd/semi-illustrations.min.js
// @icon         <$ICON$>
// ==/UserScript==
 */
(function(s,w){typeof exports=="object"&&typeof module<"u"?w(require("react"),require("react-dom"),require("@douyinfe/semi-ui"),require("@douyinfe/semi-icons")):typeof define=="function"&&define.amd?define(["react","react-dom","@douyinfe/semi-ui","@douyinfe/semi-icons"],w):(s=typeof globalThis<"u"?globalThis:s||self,w(s.React,s.ReactDOM,s.SemiUI,s.SemiIcons))})(this,function(s,w,c,X){"use strict";const F=e=>e&&typeof e=="object"&&"default"in e?e:{default:e},S=F(s),K=F(w);var A={},N=K.default;A.createRoot=N.createRoot,A.hydrateRoot=N.hydrateRoot;function Q(e){const t=new Map;for(const r of Object.keys(e))t.set(r,new Set);const n=Object.assign({},e);return n.observe=(r,u)=>{const i=t.get(r);if(i)i.add(u);else throw new Error("key is unknown")},n.unobserve=(r,u)=>{const i=t.get(r);if(i)i.delete(u);else throw new Error("key is unknown")},n.wait=(r,u,i)=>new Promise((a,d)=>{if(u(n[r]))return a();const f=t.get(r);if(!f)throw new Error("key is unknown");const C=q=>{u(q)&&(f.delete(C),a())};f.add(C),i&&setTimeout(d,i,"ReactiveData.wait Error: wait timeout")}),new Proxy(n,{set(r,u,i){if(r[u]===i)return!0;if(u==="observe"||u==="unobserve"||u==="wait")return!1;const a=t.get(u);if(!a)return!1;r[u]=i;for(let d of a)d(i);return!0}})}const _=new Set;function I(e){if(_.has(e))return;const t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,document.head.appendChild(t),_.add(e)}const z=new Map;async function Z(e){let t=z.get(e);if(t)return t;const n=await fetch(e);if(n.status!==200){console.error("\u52A0\u8F7DJSON\u8D44\u6E90\u5931\u8D25");return}return t=await n.json(),z.set(e,t),t}function v(e){return new Promise(t=>setTimeout(t,e))}function m(e){if(!e){console.error("dispatchClickEvent Error: element \u4E0D\u5B58\u5728");return}e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0}))}const l=Q({rolesUrl:"https://raw.githubusercontent.com/HUANG-CHAO-H/townsquare_assistant/master/static/roles.json",editionsUrl:"https://raw.githubusercontent.com/HUANG-CHAO-H/townsquare_assistant/master/static/editions.json",roles:{},gameStateString:"",gameState:void 0,statePolling:!1,statePollTime:300,chatTitle:"",chatContent:null,chatPolling:!1,chatPollTime:300});l.observe("rolesUrl",async e=>{if(!e)return l.roles={};l.roles=await j(e)}),l.observe("gameStateString",O),l.observe("roles",O);function j(e){return e?Z(e).then(t=>{if(!(t instanceof Array))return Promise.reject("\u52A0\u8F7Droles\u6570\u636E\u5931\u8D25");const n={};for(const r of t)n[r.id]=r;return n}):Promise.reject("url\u4E3A\u7A7A")}j(l.rolesUrl).then(e=>l.roles=e);function O(){l.gameStateString||(l.gameState=void 0);const e=JSON.parse(l.gameStateString);e.roles=e.roles||[];const t=l.roles||{};for(const n of e.players){const r=n.role;typeof r=="string"?n.role=t[r]||null:n.role=null}l.gameState=e}window.globalContext=l;function U(e){switch(e){case"townsfolk":return"\u6751\u6C11";case"outsider":return"\u5916\u6765\u8005";case"minion":return"\u722A\u7259";case"demon":return"\u6076\u9B54";case"traveler":return"\u65C5\u884C\u8005";default:return"\u672A\u77E5\u7C7B\u578B"}}function D(){const e=document.querySelector("div.menu > ul");if(!e)throw new Error("getSettingUl: \u8BBE\u7F6E\u5217\u8868\u7684 ul \u5143\u7D20\u5931\u8D25");return e}function ee(e=D()){const t=e.querySelector("li.tabs > svg.fa-question");if(!t)throw new Error("getSettingHelp: \u672A\u6355\u6349\u5230help\u6309\u94AE");return t}function L(e=D()){const t=e.querySelectorAll("li");if(!t||!t.length)throw new Error("getSettingJSON: \u672A\u6355\u83B7\u5230li\u6570\u7EC4");return t.length===9&&t[4].innerText.includes("JSON")?t[4]:null}function E(){const e=document.querySelector("div.modal-backdrop.game-state");return e?e.firstChild:(console.warn("getGameStateJsonDiv: \u672A\u6355\u83B7\u5230\u6E38\u620F\u72B6\u6001\u5F39\u7A97\u6240\u5728\u7684DIV"),null)}function te(e=E()){if(!e)return null;const t=e.querySelector("div.slot > textarea");if(!t)throw new Error("getGameStateJsonTextarea: \u672A\u6355\u83B7\u5230textarea \u8282\u70B9");return t}function ne(e){const t=document.querySelectorAll("#townsquare > ul.circle > li");if(e<1||e>t.length)throw new Error("getSeatDiv: seatNumber \u8D85\u51FA\u4E86\u9884\u5B9A\u8303\u56F4: "+e);const n=t[e-1].querySelector("div.player");if(!n)throw new Error("getSeatDiv: \u672A\u6355\u6349\u5230\u7528\u6237\u5EA7\u4F4D\u6240\u5728\u7684div");return n}function h(){const e=document.querySelector("div.df-chat-detail");return e||console.warn("getChatDetailDiv: \u672A\u6355\u83B7\u5230\u804A\u5929\u7A97\u53E3\u6240\u5728\u7684DIV"),e}function re(e=h()){if(!e)return null;const t=e.querySelector("div.title-wrap > div.title");if(!t)throw new Error("getChatTitleDiv \u672A\u6355\u83B7\u5230title\u6240\u5728\u7684div");return t}function oe(e=h()){if(!e)return null;const t=e.querySelector("div.df-scroll_wrap");if(!t)throw new Error("getChatContentDiv \u672A\u6355\u83B7\u5230content\u6240\u5728\u7684div");return t}function ue(e=h()){if(!e)return null;const t=e.querySelector("div.input-wrap div#content");if(!t)throw new Error("getChatContentDiv \u672A\u6355\u83B7\u5230\u8F93\u5165\u6846\u6240\u5728\u7684div");return t}function ie(e=h()){if(!e)return null;const t=e.querySelector("div.input-wrap > div > div.btn");if(!t)throw new Error("getChatContentDiv \u672A\u6355\u83B7\u5230\u53D1\u9001\u6309\u94AE\u6240\u5728\u7684div");return t}function le(){return R(!0)}function ae(){return R(!1)}function se(e=E()){return e?te(e).value:""}async function ce(e,t=ne(e)){let n=t.querySelector("ul.menu");if(!n){m(t.querySelector("div.name"));for(let u=0;u<10&&(n=t.querySelector("ul.menu"),!n);u++)await v(50);if(!n)throw new Error("openChatWindow Error: \u6253\u5F00\u73A9\u5BB6\u83DC\u5355\u5931\u8D25")}const r=n.lastChild;m(r);for(let u=0;u<10;u++){const i=h();if(i)return i;await v(50)}throw new Error("openChatWindow Error: \u6253\u5F00\u804A\u5929\u7A97\u53E3\u5931\u8D25")}function de(e=h()){return e?re(e).innerText:""}function he(e=h()){return e?oe(e).cloneNode(!0).childNodes:null}function fe(e="",t=h()){if(!t)return!1;const n=ue(t);n.innerHTML=e;const r=new InputEvent("input");return n.dispatchEvent(r),!0}function ge(e=h()){if(!e)return;const t=ie(e);return m(t)}async function R(e=!0){const t=E();if(e&&t||!e&&!t)return t;const n=D();let r=L(n);if(!r){m(ee(n));for(let u=0;u<10&&(r=L(n),!r);u++)await v(50);if(!r)throw new Error("\u672A\u6355\u6349\u5230JSON\u6309\u94AE")}m(r);for(let u=0;u<10;u++){const i=E();if(e&&i||!e&&!i)return i;await v(50)}throw new Error("\u6E38\u620F\u72B6\u6001\u5BF9\u8BDD\u6846\u5207\u6362\u5931\u8D25")}async function ve(){for(;;){await l.wait("statePolling",t=>Boolean(t));const e=await le();for(;l.gameStateString=se(e),await v(l.statePollTime),!!l.statePolling;);await ae()}}ve().catch(e=>console.error("gameStateLoop\u8F6E\u8BE2\u88AB\u4E2D\u65AD",e));async function ye(){for(;;)for(await l.wait("chatPolling",e=>Boolean(e));;){const e=h();if(e&&(l.chatTitle=de(e),l.chatContent=he(e)),await v(l.chatPollTime),!l.chatPolling)break}}ye().catch(e=>console.error("chatLoop\u8F6E\u8BE2\u88AB\u4E2D\u65AD",e));var b={exports:{}},x={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var pe=S.default,we=Symbol.for("react.element"),Se=Symbol.for("react.fragment"),me=Object.prototype.hasOwnProperty,Ce=pe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ee={key:!0,ref:!0,__self:!0,__source:!0};function G(e,t,n){var r,u={},i=null,a=null;n!==void 0&&(i=""+n),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(a=t.ref);for(r in t)me.call(t,r)&&!Ee.hasOwnProperty(r)&&(u[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps,t)u[r]===void 0&&(u[r]=t[r]);return{$$typeof:we,type:e,key:i,ref:a,props:u,_owner:Ce.current}}x.Fragment=Se,x.jsx=G,x.jsxs=G,function(e){e.exports=x}(b);const J=b.exports.Fragment,o=b.exports.jsx,g=b.exports.jsxs;function H(e){const{roleInfo:t,size:n,style:r}=e,[u,i]=s.useMemo(()=>{const a=`https://raw.githubusercontent.com/bra1n/townsquare/develop/src/assets/icons/${t.id}.png`,d=g("p",{children:[o("span",{style:{fontSize:"large"},children:t.name}),o(c.Tag,{color:"green",type:"solid",children:U(t.team)}),o("br",{}),o("br",{}),t.ability]});return[a,d]},[t]);return o(c.Tooltip,{content:i,children:o(c.Avatar,{size:n,src:u,style:r})})}function M(e){const{playerInfo:t,size:n,avatarStyle:r,containerStyle:u}=e,i=o(c.Avatar,{size:n||"small",src:t.avatarUrl,style:r||{marginRight:12}});let a=i,d=t.name;return t.countUnread?a=o(c.Badge,{count:t.countUnread,type:"primary",children:i}):t.isDead&&(a=o(c.Badge,{count:"\u6B7B\u4EA1",type:"danger",children:i})),t.isDead&&(d=o("span",{style:be,children:t.name})),g("div",{style:u,children:[a,d]})}const be={textDecoration:"line-through",color:"gray"},W=S.default.createContext(void 0);function $(){return s.useContext(W)}function xe(e){const[t,n]=s.useState(void 0);return s.useEffect(()=>(n(l.gameState),l.observe("gameState",n),()=>l.unobserve("gameState",n)),[]),o(W.Provider,{value:t,children:e.children})}const V=S.default.createContext(void 0);function B(){return s.useContext(V)}function Ae(e){const t=$(),[n,r]=s.useState(void 0),[u,i]=s.useState(0),[a,d]=s.useState(""),[f,C]=s.useState("");s.useEffect(()=>(d(l.chatTitle),l.observe("chatTitle",d),()=>l.unobserve("chatTitle",d)),[]),s.useEffect(()=>{if(!t)return;const y=t.players.findIndex(Re=>Re.name===a);y>=0?(r(t.players[y]),i(y+1)):(r(void 0),i(0))},[t==null?void 0:t.players,a]);const q=s.useCallback(()=>{C(y=>!y||!fe(y)?y:(v(50).then(ge),""))},[]),Le=s.useMemo(()=>({chatPlayer:n,chatPlayerSeat:u,chatTitle:a,chatContent:f,setChatContent:C,dispatchSendMsg:q}),[n,u,a,f]);return o(V.Provider,{value:Le,children:e.children})}function De(){const e=B(),t=s.useRef(null);if(s.useEffect(()=>{const u=i=>{const a=t.current;if(!a||!i)return;const d=a.firstChild,f=d.childNodes.length;d.innerHTML="",d.append(...i),f!==d.childNodes.length&&(a.scrollTop=a.scrollHeight)};return l.observe("chatContent",u),()=>l.unobserve("chatContent",u)},[]),!e)return null;const{chatPlayer:n,chatPlayerSeat:r}=e;return n?g("div",{style:Be,children:[g("div",{children:[o(c.Avatar,{color:"light-blue",shape:"square",alt:"0",children:o("span",{style:{fontSize:"x-large"},children:r})}),n.role?o(H,{roleInfo:n.role}):null,o(M,{playerInfo:n,containerStyle:{display:"inline-block"}})]}),o("div",{style:{margin:"5px 0"},children:P.map(u=>o(u,{size:"small"}))}),o("div",{ref:t,style:Pe,children:o("div",{})}),o("br",{}),g(c.Row,{gutter:16,type:"flex",align:"middle",children:[o(c.Col,{span:20,children:o(c.TextArea,{value:e.chatContent,onChange:e.setChatContent,onEnterPress:e.dispatchSendMsg})}),o(c.Col,{span:4,children:o(c.Button,{block:!0,onClick:e.dispatchSendMsg,children:"\u53D1\u9001"})})]})]}):null}const Be={color:"black",padding:"10px",height:"100%",overflow:"hidden"},Pe={height:"400px",overflowX:"auto",overflowY:"scroll",borderStyle:"inset",borderWidth:"2px"},P=[];P.push(e=>{const t=B(),n=()=>{var u,i;if(!t)return;const r=((i=(u=t.chatPlayer)==null?void 0:u.role)==null?void 0:i.firstNightReminder)||"";t.setChatContent(r)};return o(c.Button,{size:e.size,style:e.style,className:e.className,onClick:n,children:"\u751F\u6210\u9996\u591C\u4FE1\u606F"})}),P.push(e=>{const t=B(),n=()=>{var u,i;if(!t)return;const r=((i=(u=t.chatPlayer)==null?void 0:u.role)==null?void 0:i.otherNightReminder)||"";t.setChatContent(r)};return o(c.Button,{size:e.size,style:e.style,className:e.className,onClick:n,children:"\u751F\u6210\u975E\u9996\u591C\u4FE1\u606F"})});const k={width:0,height:0},ke=S.default.createContext(k);function Y(e){const t=s.useRef(null),[n,r]=s.useState(k),[u,i]=s.useState(0);return s.useEffect(()=>{let a;const d=()=>{a===void 0&&(a=setTimeout(()=>{i(f=>++f),a=void 0},300))};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),s.useEffect(()=>{const a=t.current;if(!a)return i(d=>++d);r({width:a.clientWidth||0,height:a.clientHeight||0})},[t.current,u]),o(ke.Provider,{value:n,children:o("div",{style:Te,ref:t,children:n===k?null:e.children})})}const Te={position:"relative",width:"100%",height:"100%",boxSizing:"border-box",margin:0,padding:0,overflow:"hidden"};function qe(e){const{roleId:t,name:n,size:r,style:u}=e,i=`https://raw.githubusercontent.com/bra1n/townsquare/develop/src/assets/icons/${t}.png`;return o(c.Tooltip,{content:n,children:o(c.Avatar,{size:r,src:i,style:u})})}const Fe={width:"100%",height:"100%",boxSizing:"border-box",margin:0,padding:0,overflow:"auto"};function Ne(){const e=$(),t=(e==null?void 0:e.players)||[];return o("div",{style:Fe,children:o(c.Table,{bordered:!0,columns:_e,dataSource:t,pagination:!1})})}const _e=[{title:"\u5EA7\u4F4D\u53F7",dataIndex:"seatIndex",width:50,align:"center",render(e,t,n){return String(n+1)}},{title:"\u73A9\u5BB6",dataIndex:"name",width:150,render(e,t){return o(M,{playerInfo:t,size:"small"})}},{title:"\u89D2\u8272",width:150,render(e,t){const n=t.role;return n?g("div",{children:[o(H,{roleInfo:n,style:{marginRight:12}}),n.name]}):null}},{title:"\u9996\u591C",width:50,align:"center",render(e,t){const n=t.role;return n!=null&&n.firstNight?o(c.Tooltip,{content:n.firstNightReminder||"",children:o(c.Avatar,{size:"small",color:"red",shape:"square",alt:"0",children:n.firstNight})}):null}},{title:"\u975E\u9996\u591C",width:50,align:"center",render(e,t){const n=t.role;return n!=null&&n.otherNight?o(c.Tooltip,{content:n.otherNightReminder||"",children:o(c.Avatar,{size:"small",color:"green",shape:"square",alt:"0",children:n.otherNight})}):null}},{title:"\u81EA\u5B9A\u4E49\u6807\u8BB0",width:200,align:"center",render(e,t){const n=t.reminders;return n!=null&&n.length?o(J,{children:n.map(r=>r.role==="custom"?o(c.Tooltip,{content:r.name,children:o(c.Avatar,{size:"small",color:"green",alt:"0",children:r.name})}):(console.log("reminder =",r),o(qe,{roleId:r.role,name:r.name})))}):null}},{title:"\u64CD\u4F5C",width:100,align:"center",render(e,t,n){return o(c.Button,{icon:o(X.IconComment,{style:{color:"#1abc9c"}}),onClick:()=>ce(n+1)})}}];function Ie(){const[e,t]=s.useState(!1),n=s.useCallback(()=>t(r=>!r),[]);return s.useEffect(()=>{e?(l.statePolling=!0,l.chatPolling=!0):(l.statePolling=!1,l.chatPolling=!1)},[e]),g(J,{children:[o(c.Button,{theme:"solid",type:"secondary",onClick:n,style:ze,children:"\u52A9\u624B"}),o(xe,{children:o(Ae,{children:o(c.SideSheet,{closeOnEsc:!0,placement:"bottom",height:"80%",headerStyle:je,bodyStyle:Oe,visible:e,onCancel:n,children:g(c.Row,{gutter:16,style:T,children:[o(c.Col,{style:T,span:16,children:o(Y,{children:o(Ne,{})})}),o(c.Col,{style:T,span:8,children:o(Y,{children:o(De,{})})})]})})})})]})}const ze={position:"absolute",top:0,left:"70%"},je={display:"none"},Oe={padding:0,overflow:"hidden"},T={height:"100%"},p=document.createElement("div");p.id="assist-root",p.style.position="absolute",p.style.top="0",p.style.width="100%",document.body.appendChild(p),I("https://unpkg.com/@douyinfe/semi-ui@2.17.1/dist/css/semi.css"),I("https://unpkg.com/@douyinfe/semi-icons@2.17.1/dist/css/semi-icons.css"),A.createRoot(p).render(o(S.default.StrictMode,{children:o(Ie,{})}))});
